<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css">
  <link rel="stylesheet" href="theme.css" type="text/css">
  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
  <script src="https://cdn.rawgit.com/alexvandesande/blockies/master/blockies.js"></script>
  <script type="text/javascript">
  
  Web3 = require('web3');
  //blockies = require('blockies');

  var abi = [
	{
		"constant": true,
		"inputs": [],
		"name": "getBalance",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "endorserNames",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_endorserName",
				"type": "string"
			}
		],
		"name": "endorse",
		"outputs": [],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "recipientName",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "x",
				"type": "uint8"
			}
		],
		"name": "getEndorserName",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "recipient",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "awardTitle",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getAwardDetails",
		"outputs": [
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "address[]"
			},
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "awardDate",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "awardInfo",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "endorsmentCounter",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "endorserAddresses",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "collect",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "x",
				"type": "uint8"
			}
		],
		"name": "getEndorserAddress",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"name": "_nominatorAddr",
				"type": "address"
			},
			{
				"name": "_nominatorName",
				"type": "string"
			},
			{
				"name": "_recipientAddr",
				"type": "address"
			},
			{
				"name": "_awardTitle",
				"type": "string"
			},
			{
				"name": "_awardInfo",
				"type": "string"
			},
			{
				"name": "_recipientName",
				"type": "string"
			},
			{
				"name": "_date",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "endorser",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "count",
				"type": "uint256"
			}
		],
		"name": "endorsement",
		"type": "event"
	}
];

var url = new URL(window.location.href);
var addr = url.searchParams.get("addr");

// ref lib: https://github.com/alexvandesande/blockies
// ref settings: https://github.com/ethereum/meteor-package-elements/blob/master/identicon.js#L42
// similar http://identicon.net/

function renewIcon(innerAddr, outerAddr) {

var innerIcon = blockies.create({ // All options are optional
  seed: innerAddr, //cur_account, // seed used to generate icon data, default: random
  color: '#111', // to manually specify the icon color, default: random
  bgcolor: '#eee', // choose a different background color, default: random
  size: 12, // width/height of the icon in blocks, default: 8
  scale: 8, // width/height of each block in pixels, default: 4
  spotcolor: '#224' // each pixel has a 13% chance of being of a third color, 
  // default: random. Set to -1 to disable it. These "spots" create structures
  // that look like eyes, mouths and noses. 
});

var outerIcon = blockies.create({ // All options are optional
  seed: outerAddr, //cur_account, // seed used to generate icon data, default: random
  color: '#111', // to manually specify the icon color, default: random
  bgcolor: '#eee', // choose a different background color, default: random
  size: 64, // width/height of the icon in blocks, default: 8
  scale: 2, // width/height of each block in pixels, default: 4
  spotcolor: '#522' // each pixel has a 13% chance of being of a third color, 
  // default: random. Set to -1 to disable it. These "spots" create structures
  // that look like eyes, mouths and noses. 
});

$('.award_pic').attr('src', innerIcon.toDataURL()); // icon is a canvas element
$('.award_pic_outer').attr('src', outerIcon.toDataURL()); // icon is a canvas element
}


// var addr = "0x68752e06781fa53df580e34f2e0b060fa586c6f1";
// var addr = "0x9e5aa801699f75913b50582878cf8b37bdac3f24";

  window.addEventListener('load', function () {
      if (typeof web3 !== 'undefined') {
          console.log('Web3 Detected! '); // + web3.arguments + Object.getOwnPropertyNames(web3.arguments))
          web3.currentProvider.enable();
          window.web3 = new Web3(web3.currentProvider);   
      } else {
          console.log('No Web3 Detected.  Please install MetaMask or equivalent wallet.')
          /* window.web3 = new Web3(new Web3.providers.HttpProvider("https://mainnet.infura.io/noapikey")); */
      }

      var cur_account;
      web3.eth.getAccounts(function(error, accounts) {
        cur_account = accounts[0];
        console.log("Current Account: " + accounts[0])
      });

      var from_user = {from: cur_account}; //"0xD9Df5a24e05111C14eAd75b26e7A0e12AC2A30e9"};

      console.log(addr);
      var Award = web3.eth.contract(abi).at(addr);

      Award.awardTitle.call(from_user, function(err, data) {
          document.getElementById("awardTitle").innerHTML = data;
          console.log(data);
      });

      Award.awardInfo.call(from_user, function(err, data) {
          document.getElementById("awardInfo").innerHTML = data;
          console.log(data);
      });

      Award.awardDate.call(from_user, function(err, data) {
          var d = new Date(data * 1e3).toISOString().slice(0, 10);
          document.getElementById("awardDate").innerHTML = d;
          console.log(data);
      });


      Award.recipientName.call(from_user, function(err, data) {
          document.getElementById("recipientName").innerHTML = data;
          console.log(data);
      });

      Award.recipient.call(from_user, function(err, data) {
          document.getElementById("recipientName").title = data;
          
          renewIcon(addr, data);

          console.log("recipient");
          console.log(data);
          console.log(cur_account);

          if (data == cur_account) {
          Award.getBalance.call(from_user, function(err, data) {
            console.log("getBalance"); /* See https://ethereum.stackexchange.com/questions/22859/how-to-get-value-of-a-contract-public-property-using-web3-eth */
            if (data == 0) {
              document.getElementById("collect").innerHTML = "No ETH to Collect!";
            } else {
              document.getElementById("collect").innerHTML = "Collect " + web3.fromWei(data, "ether") + " ETH";
            }
            document.getElementById("endorseFunctionality").hidden = true;
            });
          } else {
            document.getElementById("collect").hidden = true;
          }

          console.log(data);
      });


      function setItem(id){
        Award.getEndorserName.call(id, from_user, function(err, data) {
          if (!(data == null || data === "")) {
            document.getElementById(id).innerText = data;
          }
        });
        Award.getEndorserAddress.call(id, from_user, function(err, data) {
          if (!(data == null || data === "")) {
            document.getElementById(id).title = data;

            if(data == cur_account) {
              document.getElementById("endorseFunctionality").hidden = true;
            }
          }
        });

      }

      Award.endorsmentCounter.call(from_user, function(err, data) {
          console.log("endorsementCounter");
          var cnt = Number(data.toString());
          console.log(cnt);

          for (let i = 0; i <= cnt; i++) { 

              var list_id = JSON.parse(JSON.stringify(i));

              var node = document.createElement("LI");                 // Create a <li> node
              node.setAttribute("data-toggle", "tooltip");
              node.setAttribute("data-placement", "right");
              node.setAttribute("title", i);
              node.setAttribute("id", i);

              var textnode = document.createTextNode(i);         // Create a text node
              node.appendChild(textnode);                              // Append the text to <li>
              document.getElementById("endorsers").appendChild(node);     // Append <li> to <ul> with id="myList"
              setItem(i);
              console.log("e" + i.toString() + " " + data)
          }
      });
    });

function getBalance() {
    var address, wei, balance
    address = document.getElementById("address").value
    try {
        web3.eth.getBalance(address, function (error, wei) {
            if (!error) {
                var balance = web3.fromWei(wei, 'ether');
                document.getElementById("output").innerHTML = balance + " ETH";
            }
        });
    } catch (err) {
        document.getElementById("output").innerHTML = err;
    }
}
function endorse() {

  var cur_account;
  web3.eth.getAccounts(function(error, accounts) {
    cur_account = accounts[0];
    console.log("Current Account: " + accounts[0])

    var endorsementValue = document.getElementById("endorseValue").value;
    var endorsementName = document.getElementById("endorserName").value;

    endorsementValue = web3.toWei(endorsementValue, "ether");

    console.log(endorsementValue);
    console.log(endorsementName);

    var payload = {'from' : cur_account, //"0xD9Df5a24e05111C14eAd75b26e7A0e12AC2A30e9",
                  'value' : endorsementValue};

    var Award = web3.eth.contract(abi).at(addr);
    Award.endorse(endorsementName, payload, function (hash) {console.log(hash)});
    
  });
}

function collect() {

var cur_account;
web3.eth.getAccounts(function(error, accounts) {
  cur_account = accounts[0];
  console.log("Current Account: " + accounts[0])
  var payload = {'from' : cur_account}; //"0x14A0070324Cb72F9E70499dE6C6e870A1021802d"};

  var Award = web3.eth.contract(abi).at(addr);
  Award.collect(payload, function (hash) {console.log(hash)});
  });

}
</script>





</head>

<body>
  <div class="py-5">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-sm-9">
                  <h4 class="card-title"><b><span id="awardTitle">Award Title</span></b></h4>
                  <h6 class="card-subtitle my-2">Awarded to <b><span id="recipientName" data-toggle="tooltip" data-placement="right" title="0x...">Recipient</span></b> on <b><span id="awardDate">Date</span></b></h6>
                  <p class="card-text"><span id="awardInfo">Award Info Info Info Info...</span></p>
                </div>
                
                <div class="col-sm-3"><img class="award_pic" style="border-radius: 100%; z-index: 10; position: absolute; padding: 24px;"/><img class="award_pic_outer" style="border-radius: 100%; border-style: dashed; border-width: 8px;"/></div>
              </div>
              <h5 class="">Endorsed by</h5>
              <ol id="endorsers" class="">
              </ol>
              
              <div id="endorseFunctionality" class="row">
                <div class="col-sm-3"><input id="endorseValue" class="form-control" type="text" placeholder=0.01 value=0.01></div>
                <div class="col-sm-6"><input id="endorserName" class="form-control" type="text" placeholder="Anonymous"></div>
                <div class="col-sm-3"><a class="btn btn-primary" onclick="endorse();" href="#" style="border-top-width: 0px; border-bottom-width: 0px; border-radius: 3px; box-shadow: black 0px 0px 4px, black 0px 0px 4px;">Endorse</a></div>
              </div>
              
              <a id="collect" class="btn btn-primary m-4" onclick="collect();" href="#" style="	border-top-width: 10px;	border-bottom-width: 10px;	border-top-right-radius: 20px;	border-bottom-right-radius: 20px;	border-top-left-radius: 20px;	border-bottom-left-radius: 20px;	box-shadow: 0px 0px 4px  black, 0px 0px 4px  black;">Collect ## ETH</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous" style=""></script>
</body>

</html>